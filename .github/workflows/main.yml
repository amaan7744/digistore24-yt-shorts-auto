name: Digistore24 Shorts Automation (Clean)

on:
  workflow_dispatch:
  

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      # -------------------------------------------------
      # CHECKOUT
      # -------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # -------------------------------------------------
      # AGGRESSIVE DISK CLEANUP (CRITICAL)
      # -------------------------------------------------
      - name: Free disk space
        run: |
          echo "Disk before cleanup:"
          df -h

          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt-get clean

          echo "Disk after cleanup:"
          df -h

      # -------------------------------------------------
      # PYTHON SETUP
      # -------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # -------------------------------------------------
      # SYSTEM DEPS
      # -------------------------------------------------
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg fonts-dejavu-core

      # -------------------------------------------------
      # PYTHON DEPS (NO CACHE)
      # -------------------------------------------------
      - name: Install Python dependencies
        env:
          PIP_NO_CACHE_DIR: "1"
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt

      # -------------------------------------------------
      # SCRIPT
      # -------------------------------------------------
      - name: Generate script
        run: python generate_script.py

      # -------------------------------------------------
      # IMAGE FETCH
      # -------------------------------------------------
      - name: Fetch images (Pexels)
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: python fetch_images.py

      # -------------------------------------------------
      # VIDEO BUILD
      # -------------------------------------------------
      - name: Build video
        run: python make_video.py

      # -------------------------------------------------
      # UPLOAD
      # -------------------------------------------------
      - name: Upload to YouTube
        env:
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
        run: python upload_youtube.py

      # -------------------------------------------------
      # FINAL CLEANUP (VERY IMPORTANT)
      # -------------------------------------------------
      - name: Cleanup workspace
        if: always()
        run: |
          rm -rf ~/.cache/pip
          rm -rf ~/.cache/torch
          rm -rf ~/.local
          rm -rf images
          rm -rf *.mp4 *.wav *.mp3 *.png *.jpg
          echo "Final disk usage:"
          df -h
